<!DOCTYPE html>
<html ng-app="jassa.ui.edit.demo.widgets">

  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>RDF Edit Demo</title>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- build:css(.tmp) styles/main.css -->

    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/ng-grid/ng-grid.css" />
    <link rel="stylesheet" href="bower_components/jassa-ui-angular/jassa-ui-angular.css" />
    <link rel="stylesheet" href="bower_components/components-font-awesome/css/font-awesome.css" />
    <!-- endbower -->

    <link rel="stylesheet" href="../../../target/release/repo/jassa-ui-angular.css" />
    <link rel="stylesheet" href="bower_components/jquery-ui/themes/smoothness/jquery-ui.css" />

    <!-- endbuild -->

    <style>
      button.no-border-radius {
        border-radius: 0px !important;
      }

      input.margin-left-1 {
        margin-left: -1px;
      }
    </style>

    <!-- build:js scripts/scripts.js -->

    <script src="bower_components/jscache/cache.js"></script>

    <!-- bower:js -->
    <script src="bower_components/jquery/jquery.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="bower_components/jassa/jassa.js"></script>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/ng-grid/build/ng-grid.js"></script>
    <script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
    <script src="bower_components/jquery-ui/ui/jquery-ui.js"></script>
    <script src="bower_components/jassa-ui-angular/jassa-ui-angular-tpls.js"></script>
    <script src="bower_components/jassa-edit-map/index.js"></script>
    <script src="bower_components/jassa-edit-datetime/index.js"></script>
    <script src="bower_components/jassa-edit-uri/index.js"></script>
    <script src="bower_components/jassa-edit-typed/index.js"></script>
    <script src="bower_components/jassa-edit-plain/index.js"></script>
    <script src="bower_components/jassa-edit-text/index.js"></script>
    <script src="bower_components/jassa-edit-sparql-update/index.js"></script>
    <script src="bower_components/jassa-edit-sparql-meta/index.js"></script>
    <!-- endbower -->

    <script src="scripts/lib/angular-ui/0.10.0/ui-bootstrap-tpls-0.10.0.js"></script>
    <script src="bower_components/underscore.string/lib/underscore.string.js"></script>

    <script src="bower_components/openlayers/lib/OpenLayers.js"></script>
    <script src="bower_components/jqueryui-timepicker-addon/src/jquery-ui-timepicker-addon.js"></script>

    <!-- endbuild -->


    <script type="text/javascript">
    _.mixin(_.str.exports());

    var rdf = jassa.rdf;
    var sparql = jassa.sparql;
    var service = jassa.service;
    var sponate = jassa.sponate;
    var facete = jassa.facete;
    var util = jassa.util;

    var geo = jassa.geo;

    var vocab = jassa.vocab;


    var ObjectRef = Class.create({
      initialize: function(subject, predicate, objectIndex) {
        this.subject = subject;
        this.predicate = predicate;
        this.objectIndex = objectIndex;
      },

      getSubject: function() {
        return this.subject;
      },

      getPredicate: function() {
        return this.predicate;
      },

      getObjectIndex: function() {
        return this.objectIndex;
      },

      toString: function() {
        return this.subject + ' ' + this.predicate + ' ' + this.objectIndex;
      }
    });


    //this.map = new util.HashMap();


    /*
     var NodeState = Class.create({
     initialize: function() {
     this.termType = null;
     this.lexicalForm = null;
     this.datatype = null;
     this.lang = null;
     },

     getLexicalForm: function() {
     return this.lexicalForm;
     },

     getLang: function() {
     return this.lang;
     },

     setLexicalForm: function(lexicalForm) {
     this.lexicalForm = lexicalForm;
     },

     setLang: function(lang) {
     this.lang = lang;
     }
     });
     */

    var NodeStateUtils = {
      createNode: function(nodeState) {
        // TODO Implement properly
        if(nodeState.lexicalForm == null) {
          return null;
        }

        if(nodeState.hasOwnProperty('datatype')) {
          var result = rdf.NodeFactory.createTypedLiteralFromValue(nodeState.lexicalForm, nodeState.datatype);
          return result;
        }

        if(nodeState.hasOwnProperty('lang')) {
          var result = rdf.NodeFactory.createPlainLiteral(nodeState.lexicalForm, nodeState.lang);
          return result;
        }

        var result = rdf.NodeFactory.createPlainLiteral(nodeState.lexicalForm, nodeState.lang);

        return result;
      }
    };


    var TripleBuilder = Class.create({
      initialize: function() {
        //this.map = new util.HashMap();
        this.map = {};
      },
      getSafe: function(objectRef) {
        var key = '' + objectRef;
        var result = this.map[key];

        if(result == null) {
          result = {};
          this.map[key] = result;
        }

        return result;
      },
      remove: function(objectRef) {
        var key = '' + objectRef;
        delete this.map[key];
      }
    });


    var GraphInserter = Class.create({
      initialize: function(graph) {
        this.graph = graph;
        this.tripleBuilder = new TripleBuilder();
      },

      get: function(objectRef) {
        // TODO Maybe we need to check if the reference has been overridden in the triple builder
        var result = ObjectRefUtils.getTriple(this.graph, objectRef);
        return result;
      },

      set: function(objectRef, data) {
        var val = this.tripleBuilder.getSafe(objectRef);

        _(val).extend(data);

        var node = NodeStateUtils.createNode(val);
        if(node != null) {
          var t = ObjectRefUtils.getTriple(this.graph, objectRef);

          if(t != null) {
            this.graph.remove(t);
          }

          var nt = new rdf.Triple(objectRef.getSubject(), objectRef.getPredicate(), node);
          this.graph.add(nt);
        }
      }
    });

    var GraphInserterUtils = {
      getObject: function(graphInserter, objectRef) {
        var t = graphInserter.get(objectRef);
        var result = t == null ? null : t.getObject();
        return result;
      }
    };

    var ns = {};


    ns.NodeMapper = Class.create({
      toNode: function(obj) {
        console.log('Implement me');
      },
      toObject: function(node) {
        console.log('Implement me');
      }
    });


    ns.NodeMapperPlainLiteral = Class.create(ns.NodeMapper, {
      /**
       * @param fnLang function returning a language tag
       */
      initialize: function(lang) {
        this.lang = lang;
      },

      // obj is expected to be a string
      toNode: function(obj) {
        //var lang = this.fnLang();
        var result = rdf.NodeFactory.createPlainLiteral(obj, this.lang);
        return result;
      },

      toObject: function(node) {
        var result = node.getLiteralValue();
        return result;
      }
    });



    ns.ValueStore = Class.create({
      getData: function() {
        console.log('Implement me');
      },
      setData: function(data) {
        console.log('Implement me');
      }
    });

    ns.ValueStoreLex = Class.create({
      initialize: function(graphInserter, objectRef) {
        this.graphInserter = graphInserter;
        this.objectRef = objectRef;
      },

      getData: function() {
        var o = GraphInserterUtils.getObject(this.graphInserter, this.objectRef);
        var result = o == null ? null : o.getLiteralLexicalForm();
        return result;
      },

      setData: function(data) {
        this.graphInserter.set(this.objectRef, {lexicalForm: data});
      },

      getGraphInserter: function() {
        return this.graphInserter;
      },

      getObjectRef: function() {
        return this.objectRef;
      }
    });

    ns.ValueStoreLang = Class.create({
      initialize: function(graphInserter, objectRef) {
        this.graphInserter = graphInserter;
        this.objectRef = objectRef;
      },

      getData: function() {
        var o = GraphInserterUtils.getObject(this.graphInserter, this.objectRef);
        var result = o == null ? null : o.getLiteralLanguage();
        return result;
      },

      setData: function(data) {
        this.graphInserter.set(this.objectRef, {lang: data});
      },

      getGraphInserter: function() {
        return this.graphInserter;
      },

      getObjectRef: function() {
        return this.objectRef;
      }
    });

    ns.ValueStoreDatatype = Class.create({
      initialize: function(graphInserter, objectRef) {
        this.graphInserter = graphInserter;
        this.objectRef = objectRef;
      },

      getData: function() {
        var o = GraphInserterUtils.getObject(this.graphInserter, this.objectRef);
        var result = o == null ? null : o.getLiteralDatatype();
        return result;
      },

      setData: function(data) {
        this.graphInserter.set(this.objectRef, {datatype: data});
      },

      getGraphInserter: function() {
        return this.graphInserter;
      },

      getObjectRef: function() {
        return this.objectRef;
      }
    });

    var foo = ns;
    var ns = jassa.rdf;
    ns.GraphImpl = Class.create({
      initialize: function() {
        this.triples = new util.HashSet();
      },

      add: function(triple) {
        this.triples.add(triple);
      },

      remove: function(triple) {
        this.triples.remove(triple);
      },

      contains: function(triple) {
        return this.triples.contains(triple);
      },

      toArray: function() {
        return this.triples.entries();
      },

      toString: function() {
        return '' + this.triples;
      }
    });

    var ObjectRefUtils = {
      getObject: function(graph, objectRef) {
        var candidateTriple = this.getTriple(graph, objectRef);

        var result = candidateTriple ? candidateTriple.getObject() : null;
        return result;
      },

      getTriple: function(graph, objectRef) {
        var ts = graph.toArray();
        var i = 0;

        var result = _(ts).find(function(t) {
          var c = objectRef.getSubject().equals(t.getSubject()) &&
                  objectRef.getPredicate().equals(t.getPredicate());

          if(c && objectRef.getObjectIndex() === i) {
            return true;
          }

          if(c) {
            ++i;
          }
        });

        return result;
      }
    };

    var app = angular.module('jassa.ui.edit.demo.widgets', [
      'jassa.ui.edit.demo.widgets.sparqlupdate',
      'jassa.ui.edit.demo.widgets.meta',
      'jassa.ui.edit.demo.widgets.plain',
      'jassa.ui.edit.demo.widgets.typed',
      'jassa.ui.edit.demo.widgets.uri',
      'jassa.ui.edit.demo.widgets.text',
      'jassa.ui.edit.demo.widgets.map',
      'jassa.ui.edit.demo.widgets.datetime',
      'ui.bootstrap',
      'ui.jassa']);

    app.controller('AppCtrl', ['$scope', function($scope) {
      var graph = new rdf.GraphImpl();

      var s = rdf.NodeFactory.createUri('http://s');
      var p1 = rdf.NodeFactory.createUri('http://p');
      var p2 = rdf.NodeFactory.createUri('http://www.opengis.net/ont/geosparql#asWKT');
      var p3 = rdf.NodeFactory.createUri('http://p3plaintest');
      var p4 = rdf.NodeFactory.createUri('http://p4typedtest');
      var p5 = rdf.NodeFactory.createUri('http://p5datetimetest');
      var p6 = rdf.NodeFactory.createUri('http://p5timetest');
      var o1 = rdf.NodeFactory.createUri('http://o1');
      var o2 = rdf.NodeFactory.createUri('http://o2');
      var o3 = rdf.NodeFactory.createTypedLiteralFromValue("POLYGON((-15.8203125 2.4609375, -15.8203125 -10.546875, 6.85546875 -11.25, 8.26171875 -3.33984375, -15.8203125 2.4609375))", "http://www.opengis.net/ont/geosparql#wktLiteral");
      var o4 = rdf.NodeFactory.createPlainLiteral("Plain Literal with Language Tag", "en");
      var o5 = rdf.NodeFactory.createTypedLiteralFromValue("123", "http://www.w3.org/2001/XMLSchema#int");
      var o6 = rdf.NodeFactory.createTypedLiteralFromValue("2002-09-24", "http://www.w3.org/2001/XMLSchema#date");
      var o7 = rdf.NodeFactory.createTypedLiteralFromValue("21:55:16Z", "http://www.w3.org/2001/XMLSchema#time");

      var t1 = new rdf.Triple(s, p1, o1);
      var t2 = new rdf.Triple(s, p1, o2);
      var t3 = new rdf.Triple(s, p2, o3);
      var t4 = new rdf.Triple(s, p3, o4);
      var t5 = new rdf.Triple(s, p4, o5);
      var t6 = new rdf.Triple(s, p5, o6);
      var t7 = new rdf.Triple(s, p6, o7);

      graph.add(t1);
      graph.add(t2);
      graph.add(t3);
      graph.add(t4);
      graph.add(t5);
      graph.add(t6);
      graph.add(t7);

      console.log('graph', graph);
      //console.log(graph.contains(t1));

      var ref = new ObjectRef(s, p1, 0);
      var ref2 = new ObjectRef(s, p1, 1);
      var ref3 = new ObjectRef(s, p2, 0);
      var ref4 = new ObjectRef(s, p3, 0);
      var ref5 = new ObjectRef(s, p4, 0);
      var ref6 = new ObjectRef(s, p5, 0);
      var ref7 = new ObjectRef(s, p6, 0);

      console.log('Object for ref ' + ref + ': ' + ObjectRefUtils.getObject(graph, ref));
      console.log('Object for ref ' + ref2 + ': ' + ObjectRefUtils.getObject(graph, ref2));
      console.log('Object for ref3 ' + ref3 + ': ' + ObjectRefUtils.getObject(graph, ref3));
      console.log('Object for ref4 ' + ref4 + ': ' + ObjectRefUtils.getObject(graph, ref4));
      console.log('Object for ref5 ' + ref5 + ': ' + ObjectRefUtils.getObject(graph, ref5));
      console.log('Object for ref6 ' + ref6 + ': ' + ObjectRefUtils.getObject(graph, ref6));
      console.log('Object for ref7 ' + ref7 + ': ' + ObjectRefUtils.getObject(graph, ref7));

      $scope.lang = 'en';

      var graphInserter = new GraphInserter(graph);

      $scope.myValueStore = new foo.ValueStoreLex(graphInserter, ref);
      $scope.myValueStoreLang = new foo.ValueStoreLang(graphInserter, ref);

      $scope.myValueStore2 = new foo.ValueStoreLex(graphInserter, ref2);

      $scope.myValueStorePlainConfig = {
        lex: new foo.ValueStoreLex(graphInserter, ref4),
        lang: new foo.ValueStoreLang(graphInserter, ref4)
      };

      $scope.myValueStoreTypedConfig = {
        lex: new foo.ValueStoreLex(graphInserter, ref5),
        dtype: new foo.ValueStoreDatatype(graphInserter, ref5)
      };

      $scope.myValueStoreTyped = new foo.ValueStoreLex(graphInserter, ref5);

      $scope.myValueStoreDateTimeConfig = {
        lex: new foo.ValueStoreLex(graphInserter, ref6),
        dtype: new foo.ValueStoreDatatype(graphInserter, ref6)
      };

      $scope.myValueStoreDateTimeConfig2 = {
        lex: new foo.ValueStoreLex(graphInserter, ref7),
        dtype: new foo.ValueStoreDatatype(graphInserter, ref7)
      };

      $scope.myModel = "hello world";

      // Map Widget Configuration
      $scope.myMapsModel = "Foo";
      // OpenLayers Map
      $scope.mapConfig = {
        'zoom' : 8,
        'data' : 'POLYGON((-15.8203125 2.4609375, -15.8203125 -10.546875, 6.85546875 -11.25, 8.26171875 -3.33984375, -15.8203125 2.4609375))'
      };

      $scope.geometryConfig = "polygon";

      $scope.myValueStoreMap = new foo.ValueStoreLex(graphInserter, ref3);
      $scope.myValueStoreMapDatatype = new foo.ValueStoreDatatype(graphInserter, ref3);


      $scope.myValueStoreMeta = new foo.ValueStoreLex(graphInserter, ref);
      // generate graph
      $scope.datatype = "http://www.opengis.net/ont/geosparql#wktLiteral";
      $scope.graph = graph;
      $scope.$watch('"" + graph', function() {
        console.log('Graph: ' + graph);
      });

      $scope.graphImpl = graph;
      $scope.sparqlEndpoint = 'http://localhost/sparql';
    }]);
    </script>

  </head>

  <body ng-controller="AppCtrl">
    <h1>SPARQL Update</h1>
    <jassa-edit-sparql-update graph="graphImpl" endpoint="sparqlEndpoint"></jassa-edit-sparql-update>
    <h1>Simple edit with input</h1>
    <jassa-edit-text ng-model="myModel" value-store="myValueStore"></jassa-edit-text>
    <jassa-edit-text ng-model="lang" value-store="myValueStoreLang"></jassa-edit-text>
    <h1>Meta | Plain | Typed | URI Widget</h1>
    <jassa-edit-plain value-store="myValueStorePlainConfig"></jassa-edit-plain>
    <jassa-edit-typed value-store="myValueStoreTypedConfig"></jassa-edit-typed>
    <jassa-edit-uri ng-model="myMetaModel" value-store="myValueStoreMeta"></jassa-edit-uri>
    <jassa-edit-meta typed value-store="myValueStoreTypedConfig"></jassa-edit-meta>
    <jassa-edit-meta plain value-store="myValueStorePlainConfig"></jassa-edit-meta>
    <h1>DateTime Widget</h1>
    <jassa-edit-datetime value-store="myValueStoreDateTimeConfig"></jassa-edit-datetime>
    <jassa-edit-datetime value-store="myValueStoreDateTimeConfig"></jassa-edit-datetime>
    <jassa-edit-datetime value-store="myValueStoreDateTimeConfig2"></jassa-edit-datetime>
    <h1>Map widget</h1>
    <jassa-edit-text ng-model="datatype" value-store="myValueStoreMapDatatype"></jassa-edit-text>
    <jassa-edit-map ng-model="myMapsModel" config="mapConfig" geometry="geometryConfig" value-store="myValueStoreMap"></jassa-edit-map>
  </body>

</html>